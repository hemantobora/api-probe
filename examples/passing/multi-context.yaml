# Multi-Context Execution Example
# Probes multiple user contexts in a single run

executions:
  - name: "User Context A"
    vars:
      - CLIENT_ID: "client-123"
      - REGION: "us-east"
  
  - name: "User Context B"
    vars:
      - CLIENT_ID: "client-456"
      - REGION: "eu-west"
  
  - name: "User Context C"
    vars:
      - CLIENT_ID: "client-789"
      - REGION: "ap-south"

probes:
  # Probe 1: Variable substitution in endpoint and headers
  - name: "Health Check with Client ID"
    type: rest
    endpoint: "https://httpbin.org/headers"
    headers:
      X-Client-ID: "${CLIENT_ID}"
      X-Region: "${REGION}"
    validation:
      status: 200
      body:
        present:
          - "headers.X-Client-Id"
          - "headers.X-Region"
        # Verify headers were echoed correctly with variable substitution
        equals:
          headers.X-Client-Id: "${CLIENT_ID}"
          headers.X-Region: "${REGION}"
  
  # Probe 2: Variables in request body
  - name: "POST with Client Context"
    type: rest
    endpoint: "https://httpbin.org/post"
    method: POST
    headers:
      Content-Type: "application/json"
    body:
      clientId: "${CLIENT_ID}"
      region: "${REGION}"
      timestamp: "2024-01-01T00:00:00Z"
    validation:
      status: 200
      body:
        present:
          - "json.clientId"
          - "json.region"
        # Variable substitution in validation
        equals:
          json.clientId: "${CLIENT_ID}"
          json.region: "${REGION}"
    output:
      REQUEST_ID: "body.headers.X-Amzn-Trace-Id"
  
  # Probe 3: Chained probe using captured output
  - name: "Verify Request ID Captured"
    type: rest
    endpoint: "https://httpbin.org/get"
    headers:
      X-Client-ID: "${CLIENT_ID}"
      X-Previous-Request: "${REQUEST_ID}"
    validation:
      status: 200
      body:
        present:
          - "headers.X-Client-Id"

# Expected Behavior:
# Each execution runs independently with its own variables:
# 
# User Context A: CLIENT_ID=client-123, REGION=us-east
# User Context B: CLIENT_ID=client-456, REGION=eu-west  
# User Context C: CLIENT_ID=client-789, REGION=ap-south
#
# Each run is isolated - variables captured in Run 1 don't affect Run 2
